version: '2.1'  # Versão mais compatível com Railway

networks:
  aas_default:
    # external: true - comentado como sugerido

services:
  aas-env:
    image: eclipsebasyx/aas-environment:2.0.0-SNAPSHOT
    container_name: aas-env
    environment:
      - SERVER_PORT=8081
    volumes:
      - ./aas:/application/aas
      - ./basyx/aas-env.properties:/application/application.properties
    ports:
      - '3081:8081'
    restart: always
    depends_on:
      - aas-registry
      - sm-registry
      - mongo
      - mosquitto
    networks:
      - aas_default

  aas-registry:
    image: eclipsebasyx/aas-registry-log-mongodb:2.0.0-SNAPSHOT
    container_name: aas-registry
    ports:
      - '3082:8080'
    environment:
      - SERVER_PORT=8080
    volumes:
      - ./basyx/aas-registry.yml:/workspace/config/application.yml
    restart: always
    depends_on:
      - mongo
    networks:
      - aas_default

  sm-registry:
    image: eclipsebasyx/submodel-registry-log-mongodb:2.0.0-SNAPSHOT
    container_name: sm-registry
    ports:
      - '3083:8080'
    environment:
      - SERVER_PORT=8080
    volumes:
      - ./basyx/sm-registry.yml:/workspace/config/application.yml
    restart: always
    depends_on:
      - mongo
    networks:
      - aas_default

  aas-discovery:
    image: eclipsebasyx/aas-discovery:2.0.0-SNAPSHOT
    container_name: aas-discovery
    environment:
      - SERVER_PORT=8081
    volumes:
      - ./basyx/aas-discovery.properties:/application/application.properties
    ports:
      - '3084:8081'
    restart: always
    depends_on:
      - mongo
    networks:
      - aas_default

  mongo:
    image: mongo:5.0.10
    container_name: mongo
    ports:
      - '3017:27017'
    environment:
      MONGO_INITDB_ROOT_USERNAME: mongoAdmin
      MONGO_INITDB_ROOT_PASSWORD: mongoPassword
    restart: always
    # Removida a healthcheck que também pode causar problemas
    networks:
      - aas_default

  mosquitto:
    image: eclipse-mosquitto:2.0.15
    container_name: mosquitto
    ports:
      - '1885:1883'
    volumes:
      - ./mosquitto:/mosquitto
    restart: always
    # Removida a healthcheck que também pode causar problemas
    networks:
      - aas_default

  influxdb:
    image: influxdb:2
    container_name: influxdb
    ports:
      - '3086:8086'
      - '3999:9999'
    volumes:
      - ./influxdb/data:/var/lib/influxdb2
      - ./influxdb/config:/etc/influxdb2
    environment:
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=admin
      - DOCKER_INFLUXDB_INIT_PASSWORD=influxpassword
      - DOCKER_INFLUXDB_INIT_ORG=basyx
      - DOCKER_INFLUXDB_INIT_BUCKET=basyx
      - >-
        DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=S18VeAlq042B4naMX31oqIaSGmUmOLAC-DV3VIdkxDJuAhTXLTVFEchyTSmCcUAmB7Wu94KgExzV8gJaDjzR3Q==
    restart: always
    networks:
      - aas_default

  telegraf:
    image: telegraf:1.29.1
    container_name: telegraf
    volumes:
      - ./telegraf/telegraf.conf:/etc/telegraf/telegraf.conf:ro
    environment:
      INFLUX_TOKEN: >-
        S18VeAlq042B4naMX31oqIaSGmUmOLAC-DV3VIdkxDJuAhTXLTVFEchyTSmCcUAmB7Wu94KgExzV8gJaDjzR3Q==
    hostname: basyx_host
    restart: always
    depends_on:
      - influxdb
    networks:
      - aas_default

  aas-web-ui:
    image: eclipsebasyx/aas-gui:v2-241006
    container_name: aas-ui
    ports:
      - '3000:3000'
    environment:
      # Usando nomes de serviços internos em vez de localhost
      AAS_REGISTRY_PATH: http://aas-registry:8080/shell-descriptors
      SUBMODEL_REGISTRY_PATH: http://sm-registry:8080/submodel-descriptors
      AAS_REPO_PATH: http://aas-env:8081/shells
      SUBMODEL_REPO_PATH: http://aas-env:8081/submodels
      CD_REPO_PATH: http://aas-env:8081/concept-descriptions
      AAS_DISCOVERY_PATH: http://aas-discovery:8081/lookup/shells
      INFLUXDB_TOKEN: >-
        S18VeAlq042B4naMX31oqIaSGmUmOLAC-DV3VIdkxDJuAhTXLTVFEchyTSmCcUAmB7Wu94KgExzV8gJaDjzR3Q==
      DASHBOARD_SERVICE_PATH: http://dashboard-api:8085/api/elements
    restart: always
    depends_on:
      - aas-env
    networks:
      - aas_default

  dashboard-api:
    image: aaronzi/basyx-dashboard-api:SNAPSHOT_02
    container_name: dashboard-api
    ports:
      - '3085:8085'
    volumes:
      - ./basyx/aas-dashboard.yml:/application.yml
    restart: always
    depends_on:
      - mongo
    networks:
      - aas_default